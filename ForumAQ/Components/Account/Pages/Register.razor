@page "/Account/Register"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components
@using ForumAQ.Data
@using ForumAQ.Data.Services
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation
@inject IAutoRoleAssignmentService RoleAssignmentService

<PageTitle>Регистрация</PageTitle>

<div class="row">
    <div class="col-md-6 offset-md-3">
        <h2>Регистрация на ForumAQ</h2>
        <hr />

        <EditForm Model="Input" OnValidSubmit="HandleValidSubmit" FormName="registerForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="text-danger" />

            <div class="form-floating mb-3">
                <InputText @bind-Value="Input.Email" class="form-control" placeholder="name@example.com" />
                <label>Email *</label>
                <ValidationMessage For="@(() => Input.Email)" />
            </div>

            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.Password" class="form-control" placeholder="Пароль" />
                <label>Пароль *</label>
                <ValidationMessage For="@(() => Input.Password)" />
            </div>

            <div class="form-floating mb-3">
                <InputText type="password" @bind-Value="Input.ConfirmPassword" class="form-control" placeholder="Подтверждение пароля" />
                <label>Подтверждение пароля *</label>
                <ValidationMessage For="@(() => Input.ConfirmPassword)" />
            </div>

            <button type="submit" class="w-100 btn btn-lg btn-primary">Зарегистрироваться</button>

            <div class="mt-3 text-center">
                <a href="/Account/Login">Уже есть аккаунт? Войти</a>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? errorMessage;

    private async Task HandleValidSubmit()
    {
        errorMessage = null;

        var user = new ApplicationUser
        {
            UserName = Input.Email,
            Email = Input.Email,
            DisplayName = Input.Email.Split('@')[0], // Простое отображаемое имя из email
            RegistrationDate = DateTime.Now,
            EmailConfirmed = true // Если не требуется подтверждение email
        };

        var result = await UserManager.CreateAsync(user, Input.Password);

        if (result.Succeeded)
        {
            // Автоматически присваиваем роль "User" сразу при регистрации
            await RoleAssignmentService.AssignRoleOnRegistrationAsync(user);

            // Входим в систему
            await SignInManager.SignInAsync(user, isPersistent: false);

            // Переходим на главную страницу или указанную ReturnUrl
            Navigation.NavigateTo(ReturnUrl ?? "/");
        }
        else
        {
            // Собираем все ошибки в одну строку
            foreach (var error in result.Errors)
            {
                errorMessage += error.Description + " ";
            }
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Email обязателен")]
        [EmailAddress(ErrorMessage = "Введите корректный email")]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Пароль обязателен")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "Пароль должен быть от 6 до 100 символов")]
        [DataType(DataType.Password)]
        [Display(Name = "Пароль")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Подтверждение пароля")]
        [Compare("Password", ErrorMessage = "Пароли не совпадают")]
        public string ConfirmPassword { get; set; } = "";
    }
}